(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{25:function(t,e,n){},26:function(t,e,n){},27:function(t,e,n){"use strict";n.r(e);var i=n(0),a=n(3),o=n.n(a),s=n(16),r=n.n(s),c=(n(25),n(9)),l=n(10),h=n(4),d=n(1),u=n(2),b=n(6),f=n(5),g=(n(26),n(14)),v="#F5F5F5",j="#3f51b5",p="#ffffff",m=function(t){return Object(i.jsx)("div",{className:"header",style:{backgroundColor:j,color:p},children:"Pitch Detector"})},x=n.p+"static/media/play.f8ecb826.svg",C=function(t){var e=t.detectorName,n=t.windowSize,a=t.clarityThreshold,o=t.onParamChange,s=t.onStart,r=t.loading;return Object(i.jsxs)("div",{className:"full",style:{backgroundColor:v,position:"relative"},children:[Object(i.jsxs)("div",{className:"content",style:{textAlign:"center"},children:[Object(i.jsx)("h2",{children:"A Rust + WebAssembly Pitch Detector"}),Object(i.jsx)("h3",{children:"Author"}),Object(i.jsx)("span",{children:"Alessandro Genova"}),Object(i.jsx)("h3",{children:"Core Library"}),Object(i.jsxs)("span",{children:[Object(i.jsx)("a",{href:"https://github.com/alesgenova/pitch-detection",target:"_blank",children:"Source"}),Object(i.jsx)("br",{}),"(rust)"]}),Object(i.jsx)("h3",{children:"Demo App"}),Object(i.jsxs)("span",{children:[Object(i.jsx)("a",{href:"https://github.com/alesgenova/pitch-detection-app",target:"_blank",children:"Source"}),Object(i.jsx)("br",{}),"(wasm, react)"]}),Object(i.jsx)("br",{}),Object(i.jsx)("h3",{children:"Detector"}),Object(i.jsxs)("select",{value:e,onChange:function(t){o("detectorName",t.target.value)},children:[Object(i.jsx)("option",{value:"mcleod",children:"McLeod"}),Object(i.jsx)("option",{value:"autocorrelation",children:"Autocorrelation"})]}),Object(i.jsx)("h3",{children:"Window Size"}),Object(i.jsxs)("select",{value:n,onChange:function(t){o("windowSize",parseInt(t.target.value))},children:[Object(i.jsx)("option",{value:512,children:"512 samples"}),Object(i.jsx)("option",{value:1024,children:"1024 samples"}),Object(i.jsx)("option",{value:2048,children:"2048 samples"}),Object(i.jsx)("option",{value:4096,children:"4096 samples"})]}),Object(i.jsx)("h3",{children:"Clarity Threshold"}),Object(i.jsx)("input",{value:a,type:"range",min:0,max:1,step:.01,onChange:function(t){o("clarityThreshold",parseFloat(t.target.value))}}),Object(i.jsx)("br",{}),"(",a,")"]}),Object(i.jsx)("div",{className:"floating-container-center",children:Object(i.jsx)("button",{disabled:r,onClick:s,className:"floating-button-large",style:{backgroundColor:r?"#757de8":j,color:p},children:Object(i.jsx)("img",{src:x})})})]})},y=n(13),O=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],w=[[121,85,72],[158,158,158],[96,125,139],[76,175,80],[244,67,54],[33,150,243],[0,150,136],[255,235,59],[0,188,212]];function k(t){var e=Math.log(t/440)/Math.log(2)*12;return Math.round(e)+69}function S(t,e){return Math.floor(1200*Math.log(t/function(t){return 440*Math.pow(2,(t-69)/12)}(e))/Math.log(2))}function D(t){var e=Math.floor(t/12)-1,n=Math.min(e,w.length-1);return n=Math.max(0,n),w[n]}var T=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15e3,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:7e3;Object(d.a)(this,t),this.frequencies=[],this.background="#efefef",this.highlight="#888888",this.container=e,this.container.style.position="relative";var a="position: absolute; width: 100%; height: 100%;";this.bgCanvas=document.createElement("canvas"),this.bgCanvas.setAttribute("style",a),this.bgContext=this.bgCanvas.getContext("2d"),this.noteCanvas=document.createElement("canvas"),this.noteCanvas.setAttribute("style",a),this.noteContext=this.noteCanvas.getContext("2d"),this.container.appendChild(this.bgCanvas),this.container.appendChild(this.noteCanvas),this.timeSpan=n,this.timeOffset=i,this.resize()}return Object(u.a)(t,[{key:"resize",value:function(){var t=this.container.clientWidth,e=this.container.clientHeight;this.bgCanvas.width=t,this.bgCanvas.height=e,this.noteCanvas.width=t,this.noteCanvas.height=e,this.scaleX=Object(y.a)().domain([-this.timeOffset,-this.timeOffset+this.timeSpan]).range([0,t]);var n=e/(O.length+1);this.scaleY=Object(y.a)().domain([0,O.length-1]).range([e-n,n]),this.render()}},{key:"pushFrequency",value:function(t){this.frequencies.push(t)}},{key:"cleanupFrequencies",value:function(){var t=this;this.frequencies=this.frequencies.filter((function(e){return t.now-e.time<t.timeOffset}))}},{key:"render",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.now=(new Date).getTime(),this.cleanupFrequencies(),t&&this.drawBackground(),this.drawNotes()}},{key:"setBackgroundColor",value:function(t){this.background=t,this.drawBackground()}},{key:"setHighlightColor",value:function(t){this.highlight=t,this.drawBackground()}},{key:"drawBackground",value:function(){var t=this.bgCanvas.width,e=this.bgCanvas.height;this.bgContext.fillStyle=this.background,this.bgContext.clearRect(0,0,t,e),this.bgContext.fillRect(0,0,t,e);for(var n=0;n<O.length;++n){var i=this.scaleY(n);this.bgContext.fillStyle=this.highlight+"55",this.bgContext.fillRect(0,i,t,1),this.bgContext.fillStyle=this.highlight,this.bgContext.font="14px Sans",this.bgContext.fillText(O[n],this.scaleX(0)+20,i-2),this.bgContext.fillText(O[n],20,i-2)}this.bgContext.fillStyle=this.highlight+"55",this.bgContext.fillRect(this.scaleX(0),0,1,e)}},{key:"drawNotes",value:function(){var t=this.noteCanvas.width,e=this.noteCanvas.height;this.noteContext.clearRect(0,0,t,e),this.noteContext.beginPath(),this.noteContext.strokeStyle="rgba(0, 0, 0, 0.1)";var n,i=[],a=Object(l.a)(this.frequencies);try{for(a.s();!(n=a.n()).done;){var o=n.value,s=o.time,r=o.frequency,c=o.clarity,h=k(r),d=S(r,h),u=this.scaleX(s-this.now),b=this.scaleY(h%12+d/100),f=D(h);i.push({time:s,x:u,y:b,clarity:c,color:f})}}catch(N){a.e(N)}finally{a.f()}this.noteContext.beginPath();for(var g=1;g<i.length;++g){var v=i[g],j=v.x,p=v.y;v.time-i[g-1].time>500?(this.noteContext.stroke(),this.noteContext.beginPath(),this.noteContext.moveTo(j,p)):this.noteContext.lineTo(j,p)}this.noteContext.stroke();for(var m=0,x=i;m<x.length;m++){var C=x[m],y=C.x,O=C.y,w=C.clarity,T=C.color;this.noteContext.fillStyle="rgba(".concat(T[0],", ").concat(T[1],", ").concat(T[2],", ").concat(.5*w,")"),this.noteContext.beginPath(),this.noteContext.arc(y,O,3,0,2*Math.PI),this.noteContext.fill()}}}]),t}(),N=n.p+"static/media/stop.2f57eafa.svg",P=function(t){Object(b.a)(n,t);var e=Object(f.a)(n);function n(){var t;Object(d.a)(this,n);for(var i=arguments.length,a=new Array(i),s=0;s<i;s++)a[s]=arguments[s];return(t=e.call.apply(e,[this].concat(a))).audioContext=void 0,t.mediaStreamSource=void 0,t.analyser=void 0,t.buffer=void 0,t.pending=!1,t.quit=!1,t.displayElement=o.a.createRef(),t.pitchDisplay=void 0,t.mainLoop=function(){t.quit||(requestAnimationFrame(t.mainLoop),t.updatePitch())},t.onResize=function(){t.pitchDisplay&&t.pitchDisplay.resize()},t}return Object(u.a)(n,[{key:"componentDidMount",value:function(){var t=this;this.pitchDisplay=new T(this.displayElement.current,6e3,5e3),this.pitchDisplay.setBackgroundColor(v);var e=this.props,n=e.stream,i=e.workerConnection,a=e.detectorName,o=e.windowSize;i.remoteHandle().call("createDetector",a,o,o/2).then((function(){t.buffer=new Float32Array(o),t.audioContext=new AudioContext,t.mediaStreamSource=t.audioContext.createMediaStreamSource(n),t.analyser=t.audioContext.createAnalyser(),t.analyser.fftSize=o,t.mediaStreamSource.connect(t.analyser),window.addEventListener("resize",t.onResize),t.mainLoop()}))}},{key:"componentWillUnmount",value:function(){console.log("PitchComponent will unmount"),window.removeEventListener("resize",this.onResize),this.quit=!0}},{key:"updatePitch",value:function(){var t=this;if(!this.pending){this.pending=!0;var e=this.props,n=e.powerThreshold,i=e.clarityThreshold,a=e.workerConnection,o=(new Date).getTime();this.analyser.getFloatTimeDomainData(this.buffer),a.remoteHandle().call("getPitch",this.buffer,this.audioContext.sampleRate,n,i).then((function(e){var n=e[0],i=e[1];n>0&&t.pitchDisplay.pushFrequency({frequency:n,clarity:i,time:o}),t.pending=!1}))}this.pitchDisplay.render(!1)}},{key:"render",value:function(){var t=this.props.onStop;return Object(i.jsxs)("div",{className:"full",style:{position:"relative"},children:[Object(i.jsx)("div",{className:"full",style:{position:"relative"},ref:this.displayElement}),Object(i.jsx)("div",{className:"floating-container",children:Object(i.jsx)("button",{onClick:t,className:"floating-button",style:{backgroundColor:"#9c27b0",color:"#ffffff"},children:Object(i.jsx)("img",{src:N})})})]})}}]),n}(a.Component),z=function(t){Object(b.a)(n,t);var e=Object(f.a)(n);function n(t){var i;return Object(d.a)(this,n),(i=e.call(this,t)).POWER_THRESHOLD=.15,i.onStart=function(){i.setState((function(t){return Object(h.a)(Object(h.a)({},t),{},{loading:!0})}));navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,autoGainControl:!0}}).then((function(t){i.setState((function(e){return Object(h.a)(Object(h.a)({},e),{},{loading:!1,loaded:!0,stream:t})}))})).catch((function(t){console.log(t),i.setState((function(t){return Object(h.a)(Object(h.a)({},t),{},{loading:!1,loaded:!1,stream:void 0})}))}))},i.onStop=function(){var t=i.state.stream;if(t){var e,n=Object(l.a)(t.getTracks());try{for(n.s();!(e=n.n()).done;){e.value.stop()}}catch(a){n.e(a)}finally{n.f()}}i.setState((function(t){return Object(h.a)(Object(h.a)({},t),{},{loaded:!1,stream:void 0})}))},i.onParamChange=function(t,e){i.setState((function(n){return Object(h.a)(Object(h.a)({},n),{},Object(c.a)({},t,e))}))},i.state={loading:!1,loaded:!1,stream:void 0,detectorName:"mcleod",windowSize:1024,clarityThreshold:.6,workerConnection:void 0},i}return Object(u.a)(n,[{key:"componentDidMount",value:function(){var t=this,e=new Worker("".concat("/pitch-detection-app","/pitch-detection/worker.js")),n=new g.b({worker:e});Object(g.a)(n,{},5,1e3).then((function(e){t.setState({workerConnection:e})})).catch((function(){return console.log("Failed connection to worker")}))}},{key:"render",value:function(){var t=this.state,e=t.detectorName,n=t.windowSize,a=t.clarityThreshold,o=t.loading,s=t.loaded,r=t.stream,c=t.workerConnection;return Object(i.jsxs)("div",{className:"app",children:[Object(i.jsx)(m,{}),Object(i.jsxs)("div",{className:"content-container",children:[!s&&Object(i.jsx)(C,{detectorName:e,windowSize:n,clarityThreshold:a,onParamChange:this.onParamChange,onStart:this.onStart,loading:o}),s&&r&&c&&Object(i.jsx)(P,{stream:r,detectorName:e,workerConnection:c,windowSize:n,powerThreshold:this.POWER_THRESHOLD,clarityThreshold:a,onStop:this.onStop})]})]})}}]),n}(o.a.Component),F=function(t){t&&t instanceof Function&&n.e(3).then(n.bind(null,29)).then((function(e){var n=e.getCLS,i=e.getFID,a=e.getFCP,o=e.getLCP,s=e.getTTFB;n(t),i(t),a(t),o(t),s(t)}))};r.a.render(Object(i.jsx)(o.a.StrictMode,{children:Object(i.jsx)(z,{})}),document.getElementById("root")),F()}},[[27,1,2]]]);
//# sourceMappingURL=main.ad7e596d.chunk.js.map