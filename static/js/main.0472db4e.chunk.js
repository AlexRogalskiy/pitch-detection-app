(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{28:function(e,t,n){},30:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n(1),i=n.n(r),o=n(19),c=n.n(o),s=(n(28),n(12)),l=n(13),h=n(4),u=n(2),d=n(3),f=n(6),b=n(5),v=n(17),j="#F5F5F5",g="#3f51b5",p="#ffffff",m=function(e){return Object(a.jsx)("div",{className:"header",style:{backgroundColor:g,color:p},children:"Pitch Detector"})},x=function(e){var t=e.detectorName,n=e.windowSize,r=e.clarityThreshold,o=e.displayType,c=e.onParamChange;return Object(a.jsx)(i.a.Fragment,{children:Object(a.jsxs)("div",{className:"content",style:{textAlign:"center"},children:[Object(a.jsx)("h2",{children:"A Rust + WebAssembly Pitch Detector"}),Object(a.jsx)("h3",{children:"Author"}),Object(a.jsx)("span",{children:"Alessandro Genova"}),Object(a.jsx)("h3",{children:"Core Library"}),Object(a.jsxs)("span",{children:[Object(a.jsx)("a",{href:"https://github.com/alesgenova/pitch-detection",target:"_blank",children:"Source"}),Object(a.jsx)("br",{}),"(rust)"]}),Object(a.jsx)("h3",{children:"Demo App"}),Object(a.jsxs)("span",{children:[Object(a.jsx)("a",{href:"https://github.com/alesgenova/pitch-detection-app",target:"_blank",children:"Source"}),Object(a.jsx)("br",{}),"(wasm, react)"]}),Object(a.jsx)("br",{}),Object(a.jsx)("h3",{children:"Detector"}),Object(a.jsxs)("select",{value:t,onChange:function(e){c("detectorName",e.target.value)},children:[Object(a.jsx)("option",{value:"mcleod",children:"McLeod"}),Object(a.jsx)("option",{value:"autocorrelation",children:"Autocorrelation"})]}),Object(a.jsx)("h3",{children:"Window Size"}),Object(a.jsxs)("select",{value:n,onChange:function(e){c("windowSize",parseInt(e.target.value))},children:[Object(a.jsx)("option",{value:512,children:"512 samples"}),Object(a.jsx)("option",{value:1024,children:"1024 samples"}),Object(a.jsx)("option",{value:2048,children:"2048 samples"}),Object(a.jsx)("option",{value:4096,children:"4096 samples"})]}),Object(a.jsx)("h3",{children:"Clarity Threshold"}),Object(a.jsx)("input",{value:r,type:"range",min:0,max:1,step:.01,onChange:function(e){c("clarityThreshold",parseFloat(e.target.value))}}),Object(a.jsx)("br",{}),"(",r,")",Object(a.jsx)("h3",{children:"Display Type"}),Object(a.jsxs)("select",{value:o,onChange:function(e){c("displayType",e.target.value)},children:[Object(a.jsx)("option",{value:"chart",children:"Linear Chart"}),Object(a.jsx)("option",{value:"circle",children:"Circle Chart"})]})]})})},O=n(16),y=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],C=[[121,85,72],[158,158,158],[96,125,139],[76,175,80],[244,67,54],[33,150,243],[0,150,136],[255,235,59],[0,188,212]];function w(e){var t=Math.log(e/440)/Math.log(2)*12;return Math.round(t)+69}function k(e,t){return Math.floor(1200*Math.log(e/function(e){return 440*Math.pow(2,(e-69)/12)}(t))/Math.log(2))}function S(e){var t=Math.floor(e/12)-1,n=Math.min(t,C.length-1);return n=Math.max(0,n),C[n]}var M=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15e3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:7e3;Object(u.a)(this,e),this.frequencies=[],this.background="#efefef",this.highlight="#888888",this.container=t,this.container.style.position="relative";var r="position: absolute; width: 100%; height: 100%;";this.bgCanvas=document.createElement("canvas"),this.bgCanvas.setAttribute("style",r),this.bgContext=this.bgCanvas.getContext("2d"),this.noteCanvas=document.createElement("canvas"),this.noteCanvas.setAttribute("style",r),this.noteContext=this.noteCanvas.getContext("2d"),this.container.appendChild(this.bgCanvas),this.container.appendChild(this.noteCanvas),this.timeSpan=n,this.timeOffset=a,this.resize()}return Object(d.a)(e,[{key:"resize",value:function(){var e=this.container.clientWidth,t=this.container.clientHeight;this.bgCanvas.width=e,this.bgCanvas.height=t,this.noteCanvas.width=e,this.noteCanvas.height=t,this.scaleX=Object(O.a)().domain([-this.timeOffset,-this.timeOffset+this.timeSpan]).range([0,e]);var n=t/(y.length+1);this.scaleY=Object(O.a)().domain([0,y.length-1]).range([t-n,n]),this.render()}},{key:"pushFrequency",value:function(e){this.frequencies.push(e)}},{key:"cleanupFrequencies",value:function(){var e=this;this.frequencies=this.frequencies.filter((function(t){return e.now-t.time<e.timeOffset}))}},{key:"render",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.now=(new Date).getTime(),this.cleanupFrequencies(),e&&this.drawBackground(),this.drawNotes()}},{key:"setBackgroundColor",value:function(e){this.background=e,this.drawBackground()}},{key:"setHighlightColor",value:function(e){this.highlight=e,this.drawBackground()}},{key:"drawBackground",value:function(){var e=this.bgCanvas.width,t=this.bgCanvas.height;this.bgContext.fillStyle=this.background,this.bgContext.clearRect(0,0,e,t),this.bgContext.fillRect(0,0,e,t);for(var n=0;n<y.length;++n){var a=this.scaleY(n);this.bgContext.fillStyle=this.highlight+"55",this.bgContext.fillRect(0,a,e,1),this.bgContext.fillStyle=this.highlight,this.bgContext.font="14px Sans",this.bgContext.fillText(y[n],this.scaleX(0)+20,a-2),this.bgContext.fillText(y[n],20,a-2)}this.bgContext.fillStyle=this.highlight+"55",this.bgContext.fillRect(this.scaleX(0),0,1,t)}},{key:"drawNotes",value:function(){var e=this.noteCanvas.width,t=this.noteCanvas.height;this.noteContext.clearRect(0,0,e,t),this.noteContext.beginPath(),this.noteContext.strokeStyle="rgba(0, 0, 0, 0.1)";var n,a=[],r=Object(l.a)(this.frequencies);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=i.time,c=i.frequency,s=i.clarity,h=w(c),u=k(c,h),d=this.scaleX(o-this.now),f=this.scaleY(h%12+u/100),b=S(h);a.push({time:o,x:d,y:f,clarity:s,color:b})}}catch(D){r.e(D)}finally{r.f()}this.noteContext.beginPath();for(var v=1;v<a.length;++v){var j=a[v],g=j.x,p=j.y;j.time-a[v-1].time>500?(this.noteContext.stroke(),this.noteContext.beginPath(),this.noteContext.moveTo(g,p)):this.noteContext.lineTo(g,p)}this.noteContext.stroke();for(var m=0,x=a;m<x.length;m++){var O=x[m],y=O.x,C=O.y,M=O.clarity,R=O.color;this.noteContext.fillStyle="rgba(".concat(R[0],", ").concat(R[1],", ").concat(R[2],", ").concat(.5*M,")"),this.noteContext.beginPath(),this.noteContext.arc(y,C,3,0,2*Math.PI),this.noteContext.fill()}}}]),e}(),R=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(){var e;Object(u.a)(this,n);for(var a=arguments.length,r=new Array(a),o=0;o<a;o++)r[o]=arguments[o];return(e=t.call.apply(t,[this].concat(r))).displayElement=i.a.createRef(),e.pitchDisplay=void 0,e.lastRender=0,e.continuousUpdate=!0,e.onResize=function(){e.pitchDisplay&&e.pitchDisplay.resize()},e}return Object(d.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.pitchDisplay=new M(this.displayElement.current,6e3,5e3),this.pitchDisplay.setBackgroundColor(j);!function t(){e.updatePitch(),e.continuousUpdate&&requestAnimationFrame(t)}()}},{key:"componentWillUnmount",value:function(){this.continuousUpdate=!1}},{key:"updatePitch",value:function(){var e=(new Date).getTime();if(!(e-this.lastRender<17)&&this.pitchDisplay){var t=this.props,n=t.freq,a=t.clarity;n&&n>0&&this.pitchDisplay.pushFrequency({frequency:n,clarity:a||0,time:e}),this.lastRender=e,this.pitchDisplay.render(!1)}}},{key:"render",value:function(){return this.updatePitch(),Object(a.jsx)(i.a.Fragment,{children:Object(a.jsx)("div",{className:"full",style:{position:"relative"},ref:this.displayElement})})}}]),n}(r.Component),D=n(8),T=n.n(D),P=n(14),F=n(7);function N(e){var t=e.stream,n=e.detectorName,r=e.workerConnection,o=e.windowSize,c=e.powerThreshold,s=e.clarityThreshold,l=e.enabled,h=e.pitchRenderer,u=i.a.useState(null),d=Object(F.a)(u,2),f=d[0],b=d[1],v=i.a.useState(null),j=Object(F.a)(v,2),g=j[0],p=j[1],m=i.a.useRef(!1),x=i.a.useRef({}),O=i.a.useCallback(Object(P.a)(T.a.mark((function e(){var a,i;return T.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.remoteHandle().call("createDetector",n,o,o/2);case 2:(a=x.current).buffer=new Float32Array(o),a.audioContext=new AudioContext,i=a.audioContext.createMediaStreamSource(t),a.analyser=a.audioContext.createAnalyser(),a.analyser.fftSize=o,i.connect(a.analyser);case 9:case"end":return e.stop()}}),e)}))),[x,o,n,t,r]),y=i.a.useCallback(Object(P.a)(T.a.mark((function e(){var t,n,a,i,o,l,h;return T.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(m.current){e.next=15;break}if(m.current=!0,t=x.current,n=t.analyser,a=t.buffer,i=t.audioContext,n&&a&&i){e.next=7;break}return console.warn("Trying to update the pitch, but missing an analyser/buffer/audioContext"),e.abrupt("return");case 7:return n.getFloatTimeDomainData(a),e.next=10,r.remoteHandle().call("getPitch",a,i.sampleRate,c,s);case 10:o=e.sent,l=o[0],h=o[1],l>0?(b(l),p(h)):(b(null),p(null)),m.current=!1;case 15:case"end":return e.stop()}}),e)}))),[m,x,b,p,c,s,r]);i.a.useEffect((function(){if(l){console.log("Starting audio monitoring.");var e={cancelRender:!1};return Object(P.a)(T.a.mark((function e(){return T.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,O();case 2:t();case 3:case"end":return e.stop()}}),e)})))(),function(){console.log("Stopping audio monitoring."),e.cancelRender=!0}}function t(){e.cancelRender||(requestAnimationFrame(t),y())}}),[O,y,l]);var C=h;return Object(a.jsx)(C,{freq:f,clarity:g})}var q=n.p+"static/media/stop.2f57eafa.svg",A=n.p+"static/media/play.f8ecb826.svg";function E(e){var t=e.onStop;return Object(a.jsx)("div",{className:"floating-container",children:Object(a.jsx)("button",{onClick:t,className:"floating-button",style:{backgroundColor:"#9c27b0",color:"#ffffff"},children:Object(a.jsx)("img",{src:q,alt:"Stop"})})})}function z(e){var t=e.loading,n=e.onStart;return Object(a.jsx)("div",{className:"floating-container-center",children:Object(a.jsx)("button",{disabled:t,onClick:n,className:"floating-button-large",style:{backgroundColor:t?"#757de8":g,color:p},children:Object(a.jsx)("img",{src:A,alt:"Start"})})})}var B=Math.log2(440);function I(e,t,n,a){e=(e%(2*Math.PI)+2*Math.PI)%(2*Math.PI);var r=Math.PI,i=Math.tan,o=Math.atan,c=Math.sqrt,s=Math.sin,l=Math.cos,h=0,u=0;if(0===t)return[h,u];var d=o(n/2/(t+a/2)),f=o(n/2/(t+a/2));if(e<0+d||e>2*r-d)h=t,u=-(t+n/2)*i(e)-a/2;else if(e>r-d&&e<r+d)h=-t-n,u=-(t+n/2)*i(r-e)-a/2;else if(e>r/2-f&&e<r/2+f)h=c(n*n/4+(t+a/2)*(t+a/2))*s(r/2-e)-n/2,u=-(t+a);else if(e>3*r/2-f&&e<3*r/2+f)h=c(n*n/4+(t+a/2)*(t+a/2))*s(r/2-e)-n/2,u=t;else if(e>=0+d&&e<=r/2-f){var b=c(n*n/4+a*a/4),v=t,j=e-o(a/n),g=c(v*v+(l(j)*l(j)-1)*b*b)+l(j)*b;h=g*l(e)-n/2,u=-(g*s(e)+a/2)}else if(e>=r/2+f&&e<=r-d){e=r-e;var p=c(n*n/4+a*a/4),m=t,x=e-o(a/n),O=c(m*m+(l(x)*l(x)-1)*p*p)+l(x)*p;h=-(O*l(e)-n/2)-n,u=-(O*s(e)+a/2)}else if(e>=r+d&&e<=3*r/2-f){e-=r;var y=c(n*n/4+a*a/4),C=t,w=e-o(a/n),k=c(C*C+(l(w)*l(w)-1)*y*y)+l(w)*y;h=-k*l(e)-n/2,u=k*s(e)-a/2}else if(e>=3*r/2+f&&e<=2*r-d){e=2*r-e;var S=c(n*n/4+a*a/4),M=t,R=e-o(a/n),D=c(M*M+(l(R)*l(R)-1)*S*S)+l(R)*S;h=D*l(e)-n/2,u=D*s(e)-a/2}return[h,u]}var G={C:"C",Db:"C\u266f",D:"D",Eb:"D\u266f",E:"E",F:"F",Gb:"F\u266f",G:"G",Ab:"G\u266f",A:"A",Bb:"A\u266f",B:"B"},L={C:"C",Db:"D\u266d",D:"D",Eb:"E\u266d",E:"E",F:"F",Gb:"G\u266d",G:"G",Ab:"A\u266d",A:"A",Bb:"B\u266d",B:"B"};function H(e){var t=e.hz,n="sharp"===e.noteFormat?G:L,r=function(e){for(var t=Object.keys(G),n=Math.log2(e)-B,a=Math.floor(n)+4,r=((n-.25)%1+1)%1,i=0;i<12;i++)if(r>i/12-1/24&&r<=i/12+1/24)return{note:t[i],octave:a};return{note:"C",octave:a}}(t),i=r.note,o=r.octave;return Object(a.jsxs)("div",{className:"freq-container",children:[Object(a.jsxs)("span",{className:"freq-note",children:[n[i],Object(a.jsx)("span",{className:"freq-octave",children:o})]}),Object(a.jsxs)("span",{className:"freq-hz",children:[Math.round(t)," Hz"]})]})}var W=i.a.memo((function(e){var t=e.w,n=e.h,r=e.noteFormat,o=void 0===r?"sharp":r,c=i.a.useRef(null),s=i.a.useRef([{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null},{current:null}]),l=t/2,h=n/2,u=Math.min(t,n)/3,d=.6*u,f="sharp"===o?G:L,b=Object.keys(f);return i.a.useEffect((function(){var e,a=null===(e=c.current)||void 0===e?void 0:e.getContext("2d");if(a){!function(e,t){var n,a,r=Object(F.a)(t,2),i=r[0],o=r[1],c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=0,l=i/2,h=o/2,u=null!==(n=c.outerR)&&void 0!==n?n:Math.min(i,o)/3,d=null!==(a=c.innerR)&&void 0!==a?a:.6*u,f=new Path2D;f.arc(l,h,u,0,2*Math.PI),f.moveTo(l+d,h),f.arc(l,h,d,0,2*Math.PI),e.fillStyle="rgb(204,204,240)",e.fill(f,"evenodd"),e.strokeStyle="rgb(110,102,102)";for(var b=new Path2D,v=0;v<60;v++){var j=v/60*2*Math.PI-s,g=.5;v%5===0&&(g=1);var p=Math.cos(j),m=Math.sin(j);b.moveTo(p*u+l,m*u+h),b.lineTo(p*(1-.08*g)*u+l,m*(1-.08*g)*u+h)}e.lineWidth=2,e.stroke(b),e.lineWidth=1,e.stroke(f)}(a,[t,n],{innerR:d,outerR:u});for(var r=0;r<12;r++){var i=-r/12*2*Math.PI+Math.PI/2+0,o=s.current[r];if(o.current){var f=o.current,b=f.getBoundingClientRect(),v=b.width,j=b.height,g=I(i,u+4,v,j),p=Object(F.a)(g,2),m=p[0],x=p[1];f.style.left="".concat(m+l,"px"),f.style.top="".concat(x+h,"px")}}}}),[t,n,o,l,h,d,u,0]),Object(a.jsxs)(i.a.Fragment,{children:[Object(a.jsx)("canvas",{width:t,height:n,ref:c,className:"freq-background"}),s.current.map((function(e,t){return Object(a.jsx)("div",{ref:e,className:"freq-note-label",children:f[b[t]]},t)}))]})}));function U(e){var t=e.freq,n=void 0===t?440:t,r=(e.clarity,i.a.useState(400)),o=Object(F.a)(r,2),c=o[0],s=o[1],l=i.a.useState(400),h=Object(F.a)(l,2),u=h[0],d=h[1],f=i.a.useRef(null),b=i.a.useRef(null),v=function(e,t){var n=Math.min(e,t)/3;return{innerR:.6*n,outerR:n}}(c,u),j=v.innerR,g=v.outerR,p=function(e){return((Math.log2(e)-B-.5)%1+1)%1*Math.PI*2}(n||440);return i.a.useLayoutEffect((function(){function e(){var e=f.current;if(e){var t=e.getBoundingClientRect(),n=t.width,a=t.height;s(n),d(a)}}return e(),window.addEventListener("resize",e),function(){window.removeEventListener("resize",e)}}),[s,d,f]),i.a.useEffect((function(){if(b.current){var e=b.current.getContext("2d");e&&function(e,t,n){var a=Object(F.a)(t,2),r=a[0],i=a[1],o=n.angle,c=n.opacity,s=n.innerR,l=n.outerR,h=[Math.cos(o),Math.sin(o)],u=h[0],d=h[1],f=-d,b=u;e.moveTo(u*s+3*f+r/2,i/2-(d*s+3*b)),e.lineTo(u*s-3*f+r/2,i/2-(d*s-3*b)),e.lineTo(u*l+r/2,-d*l+i/2),e.fillStyle="rgba(0,128,204,".concat(c,")"),e.fill(),e.strokeStyle="rgba(0,77,204,".concat(c,")"),e.lineJoin="bevel",e.stroke()}(e,[c,u],{angle:0,opacity:.8,innerR:j,outerR:g})}}),[c,u,j,g]),Object(a.jsxs)("div",{ref:f,className:"freq-surround",children:[Object(a.jsx)(W,{w:c,h:u,noteFormat:"sharp"}),n&&Object(a.jsx)(H,{hz:n||440,noteFormat:"sharp"}),Object(a.jsx)("canvas",{className:"freq-pointer",width:c,height:u,ref:b,style:{transformOrigin:"center",transform:"rotate(".concat(p,"rad)"),visibility:n?"visible":"hidden"}})]})}var X=function(e){Object(f.a)(n,e);var t=Object(b.a)(n);function n(e){var a;return Object(u.a)(this,n),(a=t.call(this,e)).POWER_THRESHOLD=.15,a.onStart=function(){a.setState((function(e){return Object(h.a)(Object(h.a)({},e),{},{loading:!0})}));navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,autoGainControl:!0}}).then((function(e){a.setState((function(t){return Object(h.a)(Object(h.a)({},t),{},{loading:!1,loaded:!0,stream:e})}))})).catch((function(e){console.log(e),a.setState((function(e){return Object(h.a)(Object(h.a)({},e),{},{loading:!1,loaded:!1,stream:void 0})}))}))},a.onStop=function(){var e=a.state.stream;if(e){var t,n=Object(l.a)(e.getTracks());try{for(n.s();!(t=n.n()).done;){t.value.stop()}}catch(r){n.e(r)}finally{n.f()}}a.setState((function(e){return Object(h.a)(Object(h.a)({},e),{},{loaded:!1,stream:void 0})}))},a.onParamChange=function(e,t){a.setState((function(n){return Object(h.a)(Object(h.a)({},n),{},Object(s.a)({},e,t))}))},a.state={loading:!1,loaded:!1,stream:void 0,detectorName:"mcleod",windowSize:1024,clarityThreshold:.6,workerConnection:void 0,displayType:"chart"},a}return Object(d.a)(n,[{key:"componentDidMount",value:function(){var e=this,t=new Worker("".concat("/pitch-detection-app","/pitch-detection/worker.js")),n=new v.b({worker:t});Object(v.a)(n,{},5,1e3).then((function(t){e.setState({workerConnection:t})})).catch((function(){return console.log("Failed connection to worker")}))}},{key:"render",value:function(){var e=this.state,t=e.detectorName,n=e.windowSize,r=e.clarityThreshold,i=e.loading,o=e.loaded,c=e.stream,s=e.workerConnection,l=e.displayType,h=null,u=null;if(o){if(c&&s){var d="circle"===l?U:R;h=Object(a.jsx)(N,{stream:c,detectorName:t,workerConnection:s,windowSize:n,powerThreshold:this.POWER_THRESHOLD,clarityThreshold:r,enabled:!0,pitchRenderer:d}),u=Object(a.jsx)(E,{onStop:this.onStop})}}else h=Object(a.jsx)(x,{detectorName:t,windowSize:n,clarityThreshold:r,displayType:l,onParamChange:this.onParamChange}),u=Object(a.jsx)(z,{loading:i,onStart:this.onStart});return Object(a.jsxs)("div",{className:"app",style:{backgroundColor:j},children:[Object(a.jsx)(m,{}),Object(a.jsxs)("div",{className:"content-container",children:[h,u]})]})}}]),n}(i.a.Component),_=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,32)).then((function(t){var n=t.getCLS,a=t.getFID,r=t.getFCP,i=t.getLCP,o=t.getTTFB;n(e),a(e),r(e),i(e),o(e)}))};c.a.render(Object(a.jsx)(i.a.StrictMode,{children:Object(a.jsx)(X,{})}),document.getElementById("root")),_()}},[[30,1,2]]]);
//# sourceMappingURL=main.0472db4e.chunk.js.map